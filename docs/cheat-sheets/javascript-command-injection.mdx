---
slug: javascript-command-injection
---

import LinkToRegistryRule from "/src/components/LinkToRegistryRule"
import CommandInjectionIntro from "/src/components/concept/_command-injection-intro.mdx"

# Command injection prevention for JavaScript

<CommandInjectionIntro />

#### Check your project for these conditions:

```bash
semgrep --config p/javascript-command-injection
```

---

## 1. Running an OS command

### 1.A. Spawning a shell with exec function

The `exec()` function executes shell commands. It spawns a shell and then executes the command within the spawned shell, buffering any generated output. Never pass unsanitized user input to this function. Any input containing shell metacharacters can be used to trigger arbitrary command execution. 

Example:

```javascript
const {exec} = require('child_process')

const userInput = "$(dangerous command)" // Value supplied by user input

// Vunerable
exec(`cat *.js ${userInput}`, (error, stdout, stderr) => {
  console.log(stdout)
})
```

#### References

- [`child_process` module documentation](https://nodejs.org/dist/latest-v14.x/docs/api/child_process.html)

#### Mitigation

- Always try to use internal JavaScript (if it exists) instead of running an OS command. In other words, use internal language features instead of invoking commands that can be exploited.
- Don’t pass user-controlled input or use an allowlist for inputs.
- Avoid non-literal values for the command string.
- Avoid running a shell as a command with arguments.
- TODO <make these specific for each language with an exact specific array> TODO If it is not possible, use an array with a sequence of program arguments instead of a single string.
- TODO myself <Use this wording for all other command injections> TODO Strip everything except alphanumeric characters from an input provided for the command string and arguments.

#### Semgrep rule

<LinkToRegistryRule ruleId="javascript.lang.security.detect-child-process.detect-child-process" />

### 1.B. Spawning a process with spawn function

The `spawn()` and `spawnSync()` functions spawn a new process using the command with a list of arguments. This allows to spawn any programs or running shell processes with arbitrary arguments that can result in a command injection vulnerability.

Example:

```javascript
const {spawn} = require('child_process')

// Not vulnerable
const userInput = '' // value supplied by user input
spawn('cat', ['*.js', userInput])

// Vulnerable
const userInput = 'pwn-command' // value supplied by user input
spawn(userInput, ['-a', '-b'])

// Vulnerable
const userInput = 'echo 1 | cat /etc/passwd' // value supplied by user input
spawn("sh", ["-c", userInput])
```

#### References

[`child_process` module documentation](https://docs.oracle.com/javase/7/docs/api/java/lang/ProcessBuilder.html)

#### Mitigation

- Always try to use internal JavaScript (if it exists) instead of running an OS command. In other words, use internal language features instead of invoking commands that can be exploited.
- Don’t pass user-controlled input or use an allowlist for inputs.
- Avoid non-literal values for the command string.
- Avoid running a shell as a command with arguments.
- TODO <make these specific for each language with an exact specific array> TODO Define a list of allowed arguments.
- TODO myself <Use this wording for all other command injections> TODO Strip everything except alphanumeric characters from an input provided for the command string and arguments.

#### Semgrep rule

<LinkToRegistryRule ruleId="javascript.lang.security.detect-child-process.detect-child-process" />

### 1.C. spawn(...,{shell: true})

Functions from `child_process` module contains `shell` argument for specifying if the command should be executed through the shell. Using `shell: true` is dangerous because it propagates current shell settings and variables, which makes it much easier for a malicious actor to execute commands.

Example:

```javascript
const {spawn} = require('child_process')

// dangerous
spawn('ls', ['-lh', '/usr'], {shell: true});

// safe
spawn('ls', ['-lh', '/usr'], {shell: false});
```

#### References

[`child_process` module documentation](https://nodejs.org/dist/latest-v14.x/docs/api/child_process.html)

#### Mitigation

Use `shell: false` instead.

#### Semgrep rule

<LinkToRegistryRule ruleId="javascript.lang.security.audit.spawn-shell-true.spawn-shell-true" />
